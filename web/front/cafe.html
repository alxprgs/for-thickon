<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafe Dolce Goose</title>
    <link rel="icon" href="/static/photo_2025-01-04_15-52-31.jpg" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/cafe.css">

    
</head>
<body>
    <header>
        Добро пожаловать в наше Кафе!
        <div class="auth-buttons">
            <button onclick="openModal('registerModal')">Регистрация</button>
            <button onclick="openModal('loginModal')">Вход</button>
        </div>
        <div class="cart-icon" onclick="openCart()">
            <i class="fas fa-shopping-cart fa-2x"></i>
            <span class="cart-badge" id="cartCounter">0</span>
        </div>
    </header>
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Регистрация</h2>
                <span class="modal-close" onclick="closeModal('registerModal')">&times;</span>
            </div>
            <input type="tel" id="regPhone" placeholder="Номер телефона">
            <input type="password" id="regPassword" placeholder="Пароль">
            <input type="password" id="regRepeatPassword" placeholder="Повторите пароль">
            <button onclick="register()">Зарегистрироваться</button>
        </div>
    </div>
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Корзина</h2>
                <span class="modal-close" onclick="closeModal('cartModal')">&times;</span>
            </div>
            <div id="cartItems"></div>
            <p>Общая сумма: <span id="cartTotal">0</span>₽</p>
            <button onclick="createOrder()">Оформить заказ</button>
        </div>
    </div>

    <aside class="navbar">
        <img src="/static/photo_2025-01-04_15-52-31.jpg" alt="Лого">
        <ul>
            <li><a href="#home">Главная</a></li>
            <li><a href="/review">Отзывы</a></li>
            <li><a href="/menu">Меню</a></li>
            <li><a href="/onas">О нас</a></li>
        </ul>
    </aside>

    <div class="content">
        <section id="home">
            <h4>Главная</h4>
            <h4>Добро пожаловать в наше уютное кафе, еда со всего мира</h4>
        </section>

        <section id="menu">
            <h4>Блюда</h4>
            <div class="card-container">
                <div class="card" onclick="showDetails('Лобстер на гриле', 'Свежий лобстер, приготовленный на гриле, с легкой приправой и ароматными травами. Время приготовления: 20 минут. Подается с гарниром из запеченных овощей и сливочным соусом. Отличный выбор для любителей морепродуктов.', 1899)">
                    <img src="/static/image/lobster.jpg" alt="Лобстер">
                    <p>Лобстер на гриле<br>1200₽</p>
                </div>
                <div class="card" onclick="showDetails('Лосось на гриле', 'Сочный лосось, приготовленный на гриле, с медово-горчичным соусом и свежими зеленью. Время приготовления: 15 минут. Идеален для здорового питания и поклонников рыбы.', 1599)">
                    <img src="/static/image/losos.jpg" alt="Лосось">
                    <p>Лосось на гриле<br>550₽</p>
                </div>
                <div class="card" onclick="showDetails('Чизкейк', 'Нежный чизкейк с ванильным кремом и фруктами. Тонкая текстура, идеально сбалансированный вкус. Время приготовления: 10 минут. Сладкое наслаждение для ценителей десертов.', 499)">
                    <img src="/static/image/chesscake.jpg" alt="Чизкейк">
                    <p>Чизкейк<br>499₽</p>
                </div>
                <div class="card" onclick="showDetails('Салат Цезарь', 'Классический салат с курицей, листьями свежего салата, помидорами и пармезаном. Время приготовления: 10 минут. Идеальный вариант для легкого обеда или ужина.', 699)">
                    <img src="/static/image/salatcesar.jpg" alt="Салат Цезарь">
                    <p>Салат Цезарь<br>350₽</p>
                </div>
            </div>
        </section>
        
        <section id="drinks">
            <h4>Напитки</h4>
            <div class="card-container">
                <div class="card" onclick="showDetails('Кофе капучино', 'Классический капучино с нежной пенкой из молока и эспрессо. Идеально для утреннего пробуждения или небольшого перерыва. Время приготовления: 5 минут.', 299)">
                    <img src="/static/image/cappuchino.jpg" alt="Капучино">
                    <p>Кофе капучино<br>299₽</p>
                </div>
                <div class="card" onclick="showDetails('Чай зелёный', 'Свежезаваренный зелёный чай с ароматом жасмина и трав. Легкий и утоляющий жажду. Время приготовления: 3 минуты.', 199)">
                    <img src="/static/image/zelenychai.jpg" alt="Чай">
                    <p>Чай зелёный<br>199₽</p>
                </div>
                <div class="card" onclick="showDetails('Американо', 'Классический чёрный кофе с мягким вкусом и богатым ароматом. Время приготовления: 5 минут. Отличный выбор для любителей крепкого кофе.', 199)">
                    <img src="/static/image/image1_0.jpg" alt="Американо">
                    <p>Американо<br>199₽</p>
                </div>
                <div class="card" onclick="showDetails('Морс ягодный', 'Свежий ягодный морс с добавлением натурального меда. Натуральный вкус и витаминная поддержка. Время приготовления: 3 минуты.', 149)">
                    <img src="/static/image/sok.jpg" alt="Морс">
                    <p>Морс ягодный<br>149₽</p>
                </div>
            </div>
        </section>
        
        

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Вход</h2>
                <span class="modal-close" onclick="closeModal('loginModal')">&times;</span>
            </div>
            <input type="text" id="loginUsername" placeholder="Логин">
            <input type="password" id="loginPassword" placeholder="Пароль">
            <button onclick="login()">Войти</button>
        </div>
    </div>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailsTitle">Детали</h2>
                <span class="modal-close" onclick="closeModal('detailsModal')">&times;</span>
            </div>
            <p id="detailsDescription">Описание блюда</p>
            <p id="detailsPrice">Цена: 0₽</p>
            <button class="order-button" onclick="orderItem()">Добавить в корзину</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://api.prghorse.ru/v1';
        
        function getCSRFToken() {
            const token = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrf_token'))
                ?.split('=')[1];
            
            if (!token) {
                console.warn('CSRF Token not found!');
            }
            return token;
        }
            
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE_URL}/check_auth`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();
                console.log(result);
                return { status: result };
            } catch (error) {
                console.log(false);
                return { status: false };
            }
        }
    
        async function updateCartCounter() {
            try {
                const response = await fetch(`${API_BASE_URL}/cart/items`, {
                    credentials: 'include'
                });
                const data = await response.json();
                document.getElementById('cartCounter').textContent = data.cart?.length || 0;
            } catch (error) {
                console.error('Ошибка обновления корзины:', error);
            }
        }
    
        async function openCart() {
            try {
                const response = await fetch(`${API_BASE_URL}/cart/items`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                let html = '';
                let total = 0;
                
                data.cart?.forEach(item => {
                    html += `
                        <div class="cart-item">
                            ${item.name} - ${item.quantity} × ${item.price}₽
                            <button onclick="updateQuantity('${item.cart_id}', ${item.quantity + 1})">+</button>
                            <button onclick="updateQuantity('${item.cart_id}', ${item.quantity - 1})">-</button>
                            <button onclick="removeItem('${item.cart_id}')">×</button>
                        </div>
                    `;
                    total += item.price * item.quantity;
                });
    
                document.getElementById('cartItems').innerHTML = html;
                document.getElementById('cartTotal').textContent = total.toFixed(2);
                document.getElementById('cartModal').style.display = 'flex';
            } catch (error) {
                console.error('Ошибка загрузки корзины:', error);
            }
        }
    
        async function updateQuantity(cartId, newQuantity) {
            if(newQuantity < 1) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/cart/items/${cartId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCSRFToken()
                    },
                    credentials: 'include',
                    body: JSON.stringify({ quantity: newQuantity })
                });
                
                if(response.ok) {
                    await openCart();
                    await updateCartCounter();
                }
            } catch (error) {
                console.error('Ошибка обновления:', error);
            }
        }
    
        async function removeItem(cartId) {
            try {
                const response = await fetch(`${API_BASE_URL}/cart/items/${cartId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRF-Token': getCSRFToken()
                    },
                    credentials: 'include'
                });
                
                if(response.ok) {
                    await openCart();
                    await updateCartCounter();
                }
            } catch (error) {
                console.error('Ошибка удаления:', error);
            }
        }
    
        async function createOrder() {
            const csrfToken = getCSRFToken();
            
            try {
                const response = await fetch(`${API_BASE_URL}/cart/order`, {
                    method: 'POST',
                    headers: {
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include'
                });
    
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Ошибка оформления заказа');
                }
    
                window.location.href = result.payment_url;
            } catch (error) {
                alert(error.message);
            }
        }
    
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
    
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    credentials: "include",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        login: username,
                        password: password
                    })
                });
    
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'Ошибка авторизации');
                }
    
                alert('Вход выполнен успешно!');
                closeModal('loginModal');
                location.reload();
            } catch (error) {
                alert(error.message);
            }
        }
    
        async function register() {
            const phone = document.getElementById('regPhone').value;
            const password = document.getElementById('regPassword').value;
            const repeatPassword = document.getElementById('regRepeatPassword').value;
    
            try {
                const response = await fetch(`${API_BASE_URL}/reg`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        login: phone,
                        password: password,
                        repetition_password: repeatPassword
                    })
                });
    
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Ошибка регистрации');
                }
    
                alert('Регистрация успешна!');
                closeModal('registerModal');
                location.reload();
            } catch (error) {
                alert(error.message);
            }
        }
    
        async function orderItem() {
            const authCheck = await checkAuth();
            if (!authCheck.status) {
                alert('Пожалуйста, войдите в систему!');
                document.getElementById('loginModal').style.display = 'flex';
                return;
            }
    
            const name = document.getElementById('detailsTitle').innerText;
            const price = parseFloat(document.getElementById('detailsPrice').innerText.match(/[\d.]+/)[0]);
            const csrfToken = getCSRFToken();
    
            try {
                const response = await fetch(`${API_BASE_URL}/cart/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include', 
                    body: JSON.stringify({
                        name: name,
                        price: price,
                        quantity: 1
                    })
                });
    
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || `Ошибка: ${response.status}`);
                }
    
                alert(result.message);
                closeModal('detailsModal');
                await updateCartCounter();
            } catch (error) {
                console.error('Ошибка:', error);
                alert(error.message);
            }
        }
    
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
    
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
    
        function showDetails(title, description, price) {
            document.getElementById('detailsTitle').innerText = title;
            document.getElementById('detailsDescription').innerText = description;
            document.getElementById('detailsPrice').innerText = `Цена: ${price}₽`;
            document.getElementById('detailsModal').style.display = 'flex';
        }
    
        window.onload = async () => {
            const authStatus = await checkAuth();
            if(!authStatus.status) {
                document.getElementById('loginModal').style.display = 'flex';
            }
            await updateCartCounter();
        };
    </script>
</body>
</html>